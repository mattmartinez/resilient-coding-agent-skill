---
phase: 02-detection-infrastructure
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [SKILL.md]
autonomous: true
requirements: [TS-1, TS-2, TS-3, TS-4]

must_haves:
  truths:
    - "SKILL.md launch template uses background+wait wrapper that captures Claude PID to $TASK_TMPDIR/pid"
    - "SKILL.md launch template writes exit code atomically (tmp+mv) and touches done file on exit"
    - "SKILL.md launch sequence sets up tmux pipe-pane with ANSI stripping BEFORE send-keys"
    - "SKILL.md contains no __TASK_DONE__ marker references"
    - "SKILL.md cleanup section disables pipe-pane before killing session"
  artifacts:
    - path: "SKILL.md"
      provides: "Updated launch template with wrapper, pipe-pane, ANSI stripping, done-file protocol"
      contains: "pipe-pane"
  key_links:
    - from: "SKILL.md (Step 4: pipe-pane)"
      to: "SKILL.md (Step 5: send-keys)"
      via: "Ordering guarantee: pipe-pane set BEFORE send-keys"
      pattern: "pipe-pane.*-O.*perl"
    - from: "SKILL.md (wrapper)"
      to: "$TASK_TMPDIR/pid, exit_code, done"
      via: "Shell wrapper writes PID then waits then writes exit_code+done"
      pattern: 'CLAUDE_PID=\$!.*echo.*pid.*wait.*exit_code.*done'
---

<objective>
Update SKILL.md to replace the current inline launch command with the shell wrapper pattern (PID capture, done-file protocol) and add pipe-pane continuous output capture with ANSI stripping.

Purpose: SKILL.md is the orchestrator's interface. After this plan, any orchestrator following SKILL.md will automatically get PID tracking, done-file completion markers, continuous output capture, and clean ANSI-stripped logs -- the four detection signals that eliminate regex heuristics.

Output: Updated SKILL.md with new 5-step launch sequence, wrapper pattern, pipe-pane setup, and updated cleanup/monitoring sections.
</objective>

<execution_context>
@/Users/matt/.claude/get-shit-done/workflows/execute-plan.md
@/Users/matt/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-detection-infrastructure/02-RESEARCH.md
@.planning/phases/01-foundation/01-01-SUMMARY.md
@SKILL.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Replace SKILL.md launch template with wrapper + pipe-pane pattern</name>
  <files>SKILL.md</files>
  <action>
Rewrite the "Start a Task" section in SKILL.md to use the new 5-step launch sequence from the research. The changes are:

**Step 3 stays the same** (tmux new-session).

**Add new Step 4: Start output capture with ANSI stripping** -- insert BEFORE the send-keys step:
```bash
tmux pipe-pane -t claude-<task-name> -O \
  "perl -pe 's/\x1b\[[0-9;]*[mGKHfABCDJsu]//g; s/\x1b\][^\x07]*\x07//g; s/\x1b\(B//g; s/\r//g' >> $TMPDIR/output.log"
```
Add a comment explaining: pipe-pane is set BEFORE send-keys to guarantee no output is missed. The `-O` flag captures only pane output (not input). The perl chain strips four categories of ANSI escapes: CSI sequences (colors, cursor), OSC sequences (window titles), charset selection, and carriage returns (progress bars).

**Replace Step 4 (old send-keys) with new Step 5: Launch with wrapper**:
```bash
tmux send-keys -t claude-<task-name> \
  'cd <project-dir> && claude -p --model <model-name> "$(cat $TASK_TMPDIR/prompt)" & CLAUDE_PID=$!; echo "$CLAUDE_PID" > "$TASK_TMPDIR/pid"; wait $CLAUDE_PID; echo $? > "$TASK_TMPDIR/exit_code.tmp" && mv "$TASK_TMPDIR/exit_code.tmp" "$TASK_TMPDIR/exit_code" && touch "$TASK_TMPDIR/done"' Enter
```
Add a brief explanation of each wrapper step: (1) background launch, (2) PID capture via $!, (3) write PID to file, (4) wait for exit code, (5) atomic exit_code write, (6) touch done as completion signal. Note that exit_code is written BEFORE done to prevent race conditions where monitor sees done but exit_code doesn't exist yet.

**Remove all `__TASK_DONE__` references** -- delete the `&& echo "__TASK_DONE__"` from the send-keys command, delete the paragraph explaining the marker, and delete the "Phase 2 replaces this" note. Also remove `__TASK_DONE__` from the Completion Notification variant and replace with the same wrapper pattern (but including the `openclaw system event` call placed before `touch done` using `;` separator).

**Update "Completion Notification" section** to use the wrapper variant from the research:
```bash
tmux send-keys -t claude-<task-name> \
  'cd <project-dir> && claude -p --model <model-name> "$(cat $TASK_TMPDIR/prompt)" & CLAUDE_PID=$!; echo "$CLAUDE_PID" > "$TASK_TMPDIR/pid"; wait $CLAUDE_PID; ECODE=$?; echo "$ECODE" > "$TASK_TMPDIR/exit_code.tmp" && mv "$TASK_TMPDIR/exit_code.tmp" "$TASK_TMPDIR/exit_code"; openclaw system event --text "Claude done: <task-name>" --mode now; touch "$TASK_TMPDIR/done"' Enter
```
Note: openclaw event uses `;` (fire-and-forget) and is placed BEFORE `touch done`.

**Update "Monitor Progress" section**: Keep the `tmux capture-pane` commands for manual/ad-hoc progress checks, but add a note that continuous output is now available at `$TMPDIR/output.log` via pipe-pane. Add an example: `tail -n 50 $TMPDIR/output.log` for reading recent output without tmux attachment.

**Update "Health Monitoring" section**: Replace the description of the monitor's detection logic. The monitor now uses a three-priority detection flow: (1) done-file check -- if `$TASK_TMPDIR/done` exists, task completed; (2) PID liveness -- if `kill -0 $PID` fails and no done-file, task crashed, resume via `claude -c`; (3) session existence -- if tmux session gone, task lost. Remove references to "completion markers" and "crash indicators from scrollback". Keep the exponential backoff and 5-hour deadline description (those are unchanged).

**Update "Cleanup" section**: Add pipe-pane disable before session kill:
```bash
tmux pipe-pane -t claude-<task-name>  # Disable pipe-pane (prevents orphan perl processes)
tmux kill-session -t claude-<task-name>
```

**Update "Task Directory Schema" section**: Change the Phase 1 status note at the bottom. It currently says "Only `prompt` exists today." Update to: "Phase 1 created `prompt`. Phase 2 implements `pid`, `output.log`, `done`, and `exit_code` via the shell wrapper and pipe-pane patterns above."

**Update "Checklist" section**: Add step between launch and notify: "Verify pipe-pane is capturing output (`ls -la $TMPDIR/output.log`)" and update the monitor step to reference done-file/PID detection instead of `__TASK_DONE__` grep.

**Do NOT change**: Frontmatter, intro paragraph, Placeholders section, Temp Directory section, When to Use section, model mapping table, Naming Convention, Prerequisites, Limitations, Recovery After Interruption (the `claude -c` command is unchanged).
  </action>
  <verify>
Verify no `__TASK_DONE__` references remain: `grep -c "__TASK_DONE__" SKILL.md` should return 0.
Verify pipe-pane appears: `grep -c "pipe-pane" SKILL.md` should return at least 3 (setup, cleanup, explanation).
Verify wrapper pattern appears: `grep -c "CLAUDE_PID" SKILL.md` should return at least 2 (main launch + notification variant).
Verify done-file protocol: `grep -c "touch.*done" SKILL.md` should return at least 2.
Verify ANSI stripping: `grep -c "perl -pe" SKILL.md` should return at least 1.
Verify atomic write pattern: `grep -c "exit_code.tmp" SKILL.md` should return at least 2.
  </verify>
  <done>
SKILL.md contains the complete 5-step launch sequence (mktemp, write prompt, new-session, pipe-pane, send-keys with wrapper). All four detection signals (PID, done-file, output.log, ANSI stripping) are documented. No __TASK_DONE__ references remain. Cleanup disables pipe-pane before kill. Health Monitoring section describes done-file + PID detection flow.
  </done>
</task>

</tasks>

<verification>
- `grep -c "__TASK_DONE__" SKILL.md` returns 0
- `grep "pipe-pane" SKILL.md` shows setup, cleanup, and explanation references
- `grep "CLAUDE_PID" SKILL.md` shows wrapper pattern in launch commands
- `grep "perl -pe" SKILL.md` shows ANSI stripping pipeline
- `grep "exit_code.tmp" SKILL.md` shows atomic write pattern
- `grep "touch.*done" SKILL.md` shows done-file creation
- The 5-step launch sequence appears in order: mktemp -> write prompt -> new-session -> pipe-pane -> send-keys
</verification>

<success_criteria>
SKILL.md is the complete specification for orchestrators to launch tasks with all four Phase 2 detection signals. An orchestrator following SKILL.md will produce: pid file at launch, continuous ANSI-stripped output.log via pipe-pane, atomic exit_code on completion, and done file as the authoritative completion marker.
</success_criteria>

<output>
After completion, create `.planning/phases/02-detection-infrastructure/02-01-SUMMARY.md`
</output>
