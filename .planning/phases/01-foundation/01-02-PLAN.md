---
phase: 01-foundation
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - scripts/monitor.sh
autonomous: true
requirements:
  - TS-9

must_haves:
  truths:
    - "monitor.sh contains no agent-type case branches -- only Claude Code resume logic"
    - "monitor.sh accepts one argument (tmux session name) -- no agent argument"
    - "Crash recovery uses claude -c (not deprecated claude --resume)"
    - "Session name validation and exponential backoff are preserved"
    - "Completion detection via __TASK_DONE__ grep is preserved"
  artifacts:
    - path: "scripts/monitor.sh"
      provides: "Simplified Claude Code-only health monitor"
      min_lines: 40
  key_links:
    - from: "scripts/monitor.sh"
      to: "tmux session"
      via: "tmux has-session and capture-pane"
      pattern: "tmux (has-session|capture-pane)"
    - from: "scripts/monitor.sh"
      to: "Claude Code CLI"
      via: "resume command on crash detection"
      pattern: "claude -c"
---

<objective>
Simplify monitor.sh to Claude Code only -- remove all agent-type branching, update resume command, preserve monitoring loop structure.

Purpose: Eliminate dead code paths for Codex, OpenCode, and Pi from the monitor script, making it a clean single-agent monitor that subsequent phases (2-4) will build on with PID tracking, done-file detection, and manifest updates.

Output: A simplified monitor.sh with no agent-type case branches and correct Claude Code resume syntax.
</objective>

<execution_context>
@/Users/matt/.claude/get-shit-done/workflows/execute-plan.md
@/Users/matt/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation/01-RESEARCH.md
@scripts/monitor.sh
</context>

<tasks>

<task type="auto">
  <name>Task 1: Remove agent-type branching from monitor.sh</name>
  <files>scripts/monitor.sh</files>
  <action>
Rewrite scripts/monitor.sh to remove all multi-agent support. The current script takes two arguments (`<tmux-session>` and `<agent>`) and has case branches for codex, claude, opencode, and pi. The rewritten script takes ONE argument (`<tmux-session>`) and hardcodes Claude Code behavior.

Specific changes:

**Usage line (line 8-9):** Change from:
```
#   ./scripts/monitor.sh <tmux-session> <agent>
```
to:
```
#   ./scripts/monitor.sh <tmux-session>
```
Remove the `agent` parameter description entirely.

**Header comment:** Update to say "Monitor a Claude Code session running in tmux." Remove references to multiple agents.

**Arguments (lines 21-22):** Change from:
```bash
SESSION="${1:?Usage: monitor.sh <tmux-session> <agent>}"
AGENT="${2:?Usage: monitor.sh <tmux-session> <agent>}"
```
to:
```bash
SESSION="${1:?Usage: monitor.sh <tmux-session>}"
```
Remove the AGENT variable entirely.

**Agent validation (lines 25-28):** Delete the entire `case "$AGENT" in codex|claude|opencode|pi)` validation block. It is no longer needed.

**Codex session file (line 36):** Delete `CODEX_SESSION_FILE="/tmp/${SESSION}.codex-session-id"`. Not needed without Codex support.

**Crash recovery case block (lines 83-111):** Replace the entire multi-agent case statement:
```bash
case "$AGENT" in
  codex) ... ;;
  claude) ... ;;
  opencode) ... ;;
  pi) ... ;;
esac
```
with a single Claude Code resume command:
```bash
echo "Crash detected. Resuming Claude Code (retry #$RETRY_COUNT)"
tmux send-keys -t "$SESSION" 'claude -c' Enter
```
Note: Use `claude -c` (continue most recent session), NOT the deprecated `claude --resume`. The research confirms `claude -c` is the correct replacement.

**Preserve everything else:**
- `set -uo pipefail`
- Session name validation regex (`^[A-Za-z0-9._-]+$`)
- RETRY_COUNT, START_TS, DEADLINE_TS (5-hour wall-clock)
- The monitoring while loop structure
- Exponential backoff: `INTERVAL=$(( 180 * (2 ** RETRY_COUNT) ))`
- Deadline cap on sleep interval
- `tmux has-session` check
- `tmux capture-pane` output capture (120 lines, then tail 40)
- `__TASK_DONE__` completion detection (grep check)
- Shell prompt detection (`PROMPT_BACK`) and exit hint detection (`EXIT_HINT`)
- Retry count reset when agent is running normally
- "session no longer exists" break condition

The final script should be approximately 60-80 lines (down from 121) since we are removing ~40 lines of agent-type branching.
  </action>
  <verify>
Run these checks:
1. `grep -c 'codex' scripts/monitor.sh` should return 0 (no Codex references)
2. `grep -c 'opencode' scripts/monitor.sh` should return 0 (no OpenCode references)
3. `grep -ciw 'pi' scripts/monitor.sh` should return 0 (no Pi references as a standalone word)
4. `grep -c 'case.*AGENT' scripts/monitor.sh` should return 0 (no agent case branches)
5. `grep -c 'claude -c' scripts/monitor.sh` should return 1 (correct resume command)
6. `grep -c 'claude --resume' scripts/monitor.sh` should return 0 (deprecated command removed)
7. `grep -c '__TASK_DONE__' scripts/monitor.sh` should return 1 (completion detection preserved)
8. `grep -c 'DEADLINE_TS' scripts/monitor.sh` should return at least 1 (5-hour deadline preserved)
9. `bash -n scripts/monitor.sh` should exit 0 (valid bash syntax)
10. `head -1 scripts/monitor.sh` should show `#!/usr/bin/env bash` (shebang preserved)
  </verify>
  <done>
scripts/monitor.sh is a simplified Claude Code-only monitor where:
- Takes exactly one argument (tmux session name) -- no agent argument
- Contains zero references to Codex, OpenCode, or Pi
- Contains no case branches on agent type
- Uses `claude -c` for crash recovery (not deprecated `claude --resume`)
- Preserves session name validation, exponential backoff, 5-hour deadline
- Preserves `__TASK_DONE__` completion detection
- Preserves shell prompt and exit hint crash detection heuristics
- Valid bash syntax (bash -n passes)
  </done>
</task>

</tasks>

<verification>
After task completion, verify Phase 1 monitor.sh criteria:

1. **TS-9 (Claude Code only):** `grep -iE 'codex|opencode' scripts/monitor.sh` returns nothing; no `case "$AGENT"` pattern exists
2. **Resume command:** `claude -c` used instead of deprecated `claude --resume`
3. **Preserved behavior:** Exponential backoff, 5-hour deadline, completion detection, crash detection heuristics all still present
4. **Syntax valid:** `bash -n scripts/monitor.sh` exits 0
</verification>

<success_criteria>
- monitor.sh contains no agent-type case branches
- monitor.sh takes one argument (session name), not two
- Crash recovery uses `claude -c`
- Zero references to Codex, OpenCode, or Pi
- All monitoring logic (backoff, deadline, completion, crash detection) preserved
- Valid bash syntax
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation/01-02-SUMMARY.md`
</output>
