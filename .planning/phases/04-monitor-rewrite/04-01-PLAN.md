---
phase: 04-monitor-rewrite
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - scripts/monitor.sh
  - SKILL.md
autonomous: true
requirements:
  - D-3
  - D-1
  - D-6
  - D-7

must_haves:
  truths:
    - "Monitor checks done-file FIRST in every loop iteration -- completed tasks are never misidentified as crashed or hung"
    - "When PID is dead and no done-file exists, monitor dispatches 'claude -c' and updates manifest status to 'crashed' with retry_count"
    - "When process is alive but output.log mtime exceeds staleness threshold, monitor enters grace period before acting -- never kills on first stale check"
    - "Monitor intervals are configurable via MONITOR_BASE_INTERVAL (default 30s), MONITOR_MAX_INTERVAL (default 5m), MONITOR_DEADLINE (default 5h) environment variables"
    - "When deadline is reached, monitor updates manifest to 'abandoned', fires openclaw system event, and cleans up tmux session via EXIT trap"
  artifacts:
    - path: "scripts/monitor.sh"
      provides: "Three-layer deterministic monitor with configurable intervals, grace period, manifest updates, and EXIT trap"
      contains: "get_mtime"
    - path: "SKILL.md"
      provides: "Updated Health Monitoring documentation with env vars, hang detection, and cleanup behavior"
      contains: "MONITOR_BASE_INTERVAL"
  key_links:
    - from: "scripts/monitor.sh"
      to: "$TASK_TMPDIR/manifest.json"
      via: "jq merge on crash/abandoned"
      pattern: "jq.*status.*crashed|abandoned"
    - from: "scripts/monitor.sh"
      to: "$TASK_TMPDIR/output.log"
      via: "get_mtime for staleness detection"
      pattern: "get_mtime.*output\\.log"
    - from: "scripts/monitor.sh"
      to: "tmux pipe-pane/kill-session"
      via: "EXIT trap cleanup"
      pattern: "trap cleanup EXIT"
    - from: "SKILL.md"
      to: "scripts/monitor.sh"
      via: "Health Monitoring section documents monitor behavior"
      pattern: "MONITOR_BASE_INTERVAL"
---

<objective>
Rewrite scripts/monitor.sh from a two-signal detector (done-file + PID liveness) into a full three-layer deterministic monitor with hang detection, configurable intervals, manifest status updates, and EXIT trap cleanup. Update SKILL.md to document the new capabilities.

Purpose: The current monitor cannot detect hung-but-alive processes, uses hardcoded intervals, performs no manifest updates, and has no cleanup on exit. This rewrite makes the monitor production-ready with configurable behavior and clean resource management.

Output: Rewritten `scripts/monitor.sh` (~130 lines) and updated `SKILL.md` Health Monitoring section.
</objective>

<execution_context>
@/Users/matt/.claude/get-shit-done/workflows/execute-plan.md
@/Users/matt/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-monitor-rewrite/04-RESEARCH.md
@scripts/monitor.sh
@SKILL.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Rewrite monitor.sh with three-layer detection, configurable intervals, manifest updates, and EXIT trap</name>
  <files>scripts/monitor.sh</files>
  <action>
Rewrite `scripts/monitor.sh` entirely (the script is 89 lines; replacing is safer than incremental editing). Preserve existing safety patterns: session name sanitization regex, TASK_TMPDIR directory validation, done-file checked FIRST. Target ~130 lines.

**Structure the rewrite in this order:**

1. **Header and arguments** (preserve existing): `set -uo pipefail`, SESSION and TASK_TMPDIR args, session name sanitization, TASK_TMPDIR directory validation.

2. **get_mtime() helper** -- cross-platform file mtime in epoch seconds:
```bash
get_mtime() {
  local file="$1"
  stat -f %m "$file" 2>/dev/null || stat -c %Y "$file" 2>/dev/null || echo 0
}
```
The `|| echo 0` fallback treats missing/unreadable files as epoch 0 (infinitely old) -- safe failure mode. macOS uses `stat -f %m`, Linux uses `stat -c %Y`.

3. **Env var configuration block** -- all four configurable intervals with bash default-value expansion:
```bash
MONITOR_BASE_INTERVAL="${MONITOR_BASE_INTERVAL:-30}"
MONITOR_MAX_INTERVAL="${MONITOR_MAX_INTERVAL:-300}"
MONITOR_DEADLINE="${MONITOR_DEADLINE:-18000}"
MONITOR_GRACE_PERIOD="${MONITOR_GRACE_PERIOD:-30}"
```

4. **State variables** -- initialized before the loop:
```bash
RETRY_COUNT=0
STALE_SINCE=""
START_TS="$(date +%s)"
DEADLINE_TS=$(( START_TS + MONITOR_DEADLINE ))
```

5. **EXIT trap (cleanup function)** -- fires on all exit paths. MUST guard against overwriting completed manifest:
```bash
cleanup() {
  if [ -f "$TASK_TMPDIR/manifest.json" ] && [ ! -f "$TASK_TMPDIR/done" ]; then
    jq \
      --arg status "abandoned" \
      --arg abandoned_at "$(date -u +"%Y-%m-%dT%H:%M:%SZ")" \
      '. + {status: $status, abandoned_at: $abandoned_at}' \
      "$TASK_TMPDIR/manifest.json" \
      > "$TASK_TMPDIR/manifest.json.tmp" \
      && mv "$TASK_TMPDIR/manifest.json.tmp" "$TASK_TMPDIR/manifest.json"
    openclaw system event --text "Task abandoned: $SESSION" --mode now
  fi
  tmux pipe-pane -t "$SESSION" 2>/dev/null || true
  tmux kill-session -t "$SESSION" 2>/dev/null || true
}
trap cleanup EXIT
```
Key details: `|| true` on tmux commands prevents trap failure if session already gone. Guard `[ ! -f done ]` prevents overwriting completed manifest. `openclaw system event` fires only for non-completed tasks.

6. **Main loop** with three-layer detection in this EXACT priority order:

  a. **Deadline check** at top of loop:
  ```bash
  NOW_TS="$(date +%s)"
  if [ "$NOW_TS" -ge "$DEADLINE_TS" ]; then
    echo "Deadline reached (${MONITOR_DEADLINE}s). Stopping monitor."
    exit 1  # EXIT trap fires
  fi
  ```

  b. **Interval calculation** with exponential backoff capped at MAX and REMAINING:
  ```bash
  INTERVAL=$(( MONITOR_BASE_INTERVAL * (2 ** RETRY_COUNT) ))
  [ "$INTERVAL" -gt "$MONITOR_MAX_INTERVAL" ] && INTERVAL=$MONITOR_MAX_INTERVAL
  REMAINING=$(( DEADLINE_TS - NOW_TS ))
  [ "$INTERVAL" -gt "$REMAINING" ] && [ "$REMAINING" -gt 0 ] && INTERVAL=$REMAINING
  ```

  c. **Session existence check** via `tmux has-session`.

  d. **PID file wait** -- if no `$TASK_TMPDIR/pid`, sleep and continue.

  e. **Layer 1: Done-file** -- if `$TASK_TMPDIR/done` exists, read exit_code, echo completion, `exit 0`. The EXIT trap fires but the guard prevents abandoned manifest update.

  f. **Layer 2: PID liveness** -- if `kill -0 "$PID"` fails (process dead, no done-file):
     - Clear STALE_SINCE (crash, not stale)
     - Increment RETRY_COUNT
     - Update manifest to `status: "crashed"` with `retry_count` and `last_checked_at` using `jq '. + {...}'` merge pattern (write to .tmp then mv)
     - Dispatch resume: `tmux send-keys -t "$SESSION" 'claude -c' Enter`
     - `sleep 10` then `continue` (grace period for new process startup, per Phase 2 decision)

  g. **Layer 3: Output staleness** (only reached when process alive, no done-file):
     - Check if `$TASK_TMPDIR/output.log` exists
     - Compute `OUTPUT_AGE = NOW_TS - get_mtime(output.log)`
     - `STALENESS_THRESHOLD = MONITOR_BASE_INTERVAL * 3` (90s with default 30s base)
     - If `OUTPUT_AGE > STALENESS_THRESHOLD`:
       - If `STALE_SINCE` is empty: set `STALE_SINCE="$NOW_TS"`, log "Grace period started", do NOT act
       - If `STALE_SINCE` is set and `NOW_TS - STALE_SINCE >= MONITOR_GRACE_PERIOD`: grace expired -- clear STALE_SINCE, increment RETRY_COUNT, update manifest to "crashed", dispatch `claude -c`, sleep 10, continue
     - If `OUTPUT_AGE <= STALENESS_THRESHOLD`: clear STALE_SINCE (fresh output)

  h. **Healthy state** -- if reached Layer 3 but output is fresh, the process is healthy. Do NOT reset RETRY_COUNT here (it resets only when output is fresh in Layer 3). Wait, per research: "Fresh output: clear STALE_SINCE, reset RETRY_COUNT -- healthy". So yes, reset RETRY_COUNT=0 when output is fresh.

  i. **Sleep INTERVAL** at bottom of loop.

**Anti-patterns to avoid (from research):**
- DO NOT use `stat` without the `get_mtime()` helper
- DO NOT kill/resume on the first stale check (grace period required)
- DO NOT reset STALE_SINCE before acting on grace expiry
- DO NOT use `claude --resume` -- use `claude -c` (established Phase 1 decision)
- DO NOT use `&&` for openclaw in EXIT trap -- notification failure must not prevent cleanup
- DO NOT forget `|| true` on tmux commands in EXIT trap

**Update the header comment** to reflect the new capabilities: three-layer detection (done-file, PID liveness, output staleness), configurable intervals, manifest updates, EXIT trap cleanup.
  </action>
  <verify>
Run `bash -n scripts/monitor.sh` to verify no syntax errors.

Verify the script contains all required elements:
- `grep -c 'get_mtime' scripts/monitor.sh` returns at least 2 (definition + usage)
- `grep -c 'MONITOR_BASE_INTERVAL' scripts/monitor.sh` returns at least 2
- `grep -c 'MONITOR_MAX_INTERVAL' scripts/monitor.sh` returns at least 1
- `grep -c 'MONITOR_DEADLINE' scripts/monitor.sh` returns at least 1
- `grep -c 'MONITOR_GRACE_PERIOD' scripts/monitor.sh` returns at least 1
- `grep -c 'STALE_SINCE' scripts/monitor.sh` returns at least 3
- `grep -c 'trap cleanup EXIT' scripts/monitor.sh` returns 1
- `grep -c 'openclaw system event' scripts/monitor.sh` returns 1
- `grep -c 'claude -c' scripts/monitor.sh` returns at least 2
- `grep -c 'status.*abandoned' scripts/monitor.sh` returns at least 1
- `grep -c 'status.*crashed' scripts/monitor.sh` returns at least 1

Verify the three-layer ordering: done-file check appears before kill -0, which appears before get_mtime usage in the main loop.

Count lines: `wc -l scripts/monitor.sh` should be approximately 120-150 lines.
  </verify>
  <done>
scripts/monitor.sh contains: (1) get_mtime() cross-platform helper, (2) four configurable env vars with defaults, (3) three-layer detection in correct priority order (done-file > PID liveness > output staleness), (4) grace period via STALE_SINCE that never acts on first stale check, (5) manifest updates on crash (status: crashed, retry_count, last_checked_at) and abandoned (status: abandoned, abandoned_at) via jq merge, (6) EXIT trap that guards against overwriting completed manifest, fires openclaw notification, and cleans up tmux session, (7) exponential backoff with configurable intervals. Script passes `bash -n` syntax check.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update SKILL.md Health Monitoring section with env vars, hang detection, and cleanup</name>
  <files>SKILL.md</files>
  <action>
Update the "Health Monitoring" section of SKILL.md to document the Phase 4 capabilities. This is a documentation update -- no structural changes to other sections.

**Replace the current Health Monitoring section** (lines ~178-190 in the current file) with an expanded version that covers:

1. **Keep the opening paragraph** about using `scripts/monitor.sh` for long-running tasks.

2. **Update the detection flow** from two layers to three layers:
   - Layer 1: Done-file check (unchanged)
   - Layer 2: PID liveness check (unchanged)
   - Layer 3: **NEW** -- Output staleness check. If the process is alive but `output.log` mtime exceeds the staleness threshold (3x base interval), the monitor enters a grace period. If output remains stale for the grace period duration, the monitor treats it as a hang and resumes via `claude -c`.

3. **Add a "Configuration" subsection** (### Configuration) documenting the four env vars:

| Variable | Default | Purpose |
|----------|---------|---------|
| `MONITOR_BASE_INTERVAL` | `30` (seconds) | Base polling interval; doubles on each consecutive failure |
| `MONITOR_MAX_INTERVAL` | `300` (5 minutes) | Maximum polling interval cap |
| `MONITOR_DEADLINE` | `18000` (5 hours) | Wall-clock deadline; monitor exits after this |
| `MONITOR_GRACE_PERIOD` | `30` (seconds) | Grace period before acting on stale output |

Include a note: "Override by setting environment variables before launching the monitor. The staleness threshold is derived as 3x `MONITOR_BASE_INTERVAL` (default: 90 seconds)."

4. **Add a "Cleanup and Abandonment" subsection** (### Cleanup and Abandonment) explaining:
   - When the deadline is reached or the monitor is terminated, an EXIT trap fires
   - The trap updates `manifest.json` status to `"abandoned"` (unless the task already completed)
   - The trap fires an `openclaw system event` notification
   - The trap disables pipe-pane and kills the tmux session
   - This replaces the need for manual cleanup after deadline exhaustion

5. **Remove the old paragraph** about "The orchestrator should run this check loop periodically (every 3-5 minutes, via cron or a background timer)" -- this is now outdated since the monitor handles its own intervals.

6. **Keep the existing "done-file is checked FIRST" explanation** -- it's still accurate and important.

Do NOT change any other sections of SKILL.md (Placeholders, Start a Task, Monitor Progress, Recovery, Cleanup, etc.).
  </action>
  <verify>
Read the updated SKILL.md and verify:
- Health Monitoring section mentions all three detection layers
- "MONITOR_BASE_INTERVAL" appears in the configuration table
- "MONITOR_GRACE_PERIOD" appears in the configuration table
- "Cleanup and Abandonment" subsection exists
- "abandoned" status mentioned
- "openclaw system event" mentioned
- No mention of "every 3-5 minutes, via cron" (removed)
- Other sections (Start a Task, Monitor Progress, etc.) are unchanged
  </verify>
  <done>
SKILL.md Health Monitoring section documents: (1) three-layer detection flow with hang detection via output staleness, (2) configuration table with all four env vars and their defaults, (3) cleanup and abandonment behavior including EXIT trap, manifest update, and openclaw notification. All other SKILL.md sections remain unchanged.
  </done>
</task>

</tasks>

<verification>
1. `bash -n scripts/monitor.sh` -- no syntax errors
2. monitor.sh Layer 1 (done-file) appears before Layer 2 (kill -0) which appears before Layer 3 (get_mtime) in the main loop
3. All four env vars (MONITOR_BASE_INTERVAL, MONITOR_MAX_INTERVAL, MONITOR_DEADLINE, MONITOR_GRACE_PERIOD) present in both monitor.sh and SKILL.md
4. EXIT trap with done-file guard present in monitor.sh
5. Manifest updates use `jq '. + {...}'` merge pattern with atomic tmp+mv writes
6. SKILL.md other sections (Start a Task, Monitor Progress, Recovery, Cleanup, Checklist) unchanged
7. `claude -c` used for resume (not `claude --resume`)
</verification>

<success_criteria>
- monitor.sh passes `bash -n` syntax check
- Three-layer detection in correct priority order: done-file > PID liveness > output staleness
- Grace period prevents action on first stale check
- All four env vars configurable with documented defaults
- Manifest updated to "crashed" on crash, "abandoned" on deadline
- EXIT trap fires openclaw notification and cleans up tmux session
- SKILL.md documents all new capabilities in Health Monitoring section
</success_criteria>

<output>
After completion, create `.planning/phases/04-monitor-rewrite/04-01-SUMMARY.md`
</output>
